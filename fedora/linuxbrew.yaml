---
- name: Check if linuxbrew is installed
  stat:
    path: /home/linuxbrew/.linuxbrew/bin/brew
  register: linuxbrew_status

- name: Linuxbrew
  when: not linuxbrew_status.stat.exists
  block:
    - name: Install the 'Development tools' package group
      yum:
        name: "@Development tools"
        state: present

    - name: Create linuxbrew directory
      file:
        path: "/home/linuxbrew"
        owner: root
        group: root
        state: directory
        mode: 0755

    - name: Create .linuxbrew directory
      file:
        path: "/home/linuxbrew/.linuxbrew"
        owner: "{{ user.name }}"
        group: "{{ user.name }}"
        state: directory
        mode: 0755

    - name: Linuxbrew temporary directory
      become_user: "{{ user.name }}"
      file:
        path: "/tmp/linuxbrew"
        mode: 0777
        state: directory

    - name: Download Linuxbrew install script
      become_user: "{{ user.name }}"
      get_url:
        url: "{{ linuxbrew.install_url }}"
        dest: "/tmp/linuxbrew/install.sh"
        checksum: "{{ linuxbrew.install_checksum }}"
        mode: ug=rwx,o=

    - name: Install Linuxbrew
      become: true
      become_user: "{{ user.name }}"
      become_method: sudo
      shell: sh -c "/tmp/linuxbrew/install.sh" < /dev/null
      register: install_result
      changed_when: "install_result.rc == 0"

    - name: Remove linuxbrew temporary directory
      become_user: "{{ user.name }}"
      file:
        path: "/tmp/linuxbrew"
        state: absent

- name: Check if linuxbrew is installed after installation
  stat:
    path: /home/linuxbrew/.linuxbrew/bin/brew
  register: linuxbrew_status

- name: Install brew bundles
  when: linuxbrew_status.stat.exists
  become_user: "{{ user.name }}"
  block:
    - name: Copy Brewfile
      copy:
        src: "fedora/Brewfile"
        dest: "/tmp/Brewfile"
        owner: "{{ user.name }}"
        group: "{{ user.name }}"
        mode: "0644"

    - name: Install brew packages
      shell: eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)" && brew bundle --file=/tmp/Brewfile

    - name: Remove Brewfile
      file:
        path: "/tmp/Brewfile"
        state: absent
